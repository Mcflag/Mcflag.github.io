title: 21、Swift内存管理
date: 2017-04-13 21:27:06
tags: [Swift]
categories: [Swift]
---

## 摘要
Swift内存管理
<!--more-->


## deinit析构函数
	
deinit函数不需要参数。直接在函数中类似init函数一样写即可。用来关闭释放内存空间。
	
在作用域内声明的变量作用域完结时会执行析构函数释放资源。

## 引用计数
	
引用计数只用变为0的时候相应的内存空间才会被释放。

## 强引用循环与weak
	
强引用循环表示如果有两个内存空间互相引用，这时的引用计数都不为0，所以不会被回收，但是实际上这样的两个内存空间如果没有外部的引用了，是根本就没有用的内存空间但是又不会自动被回收，导致了内存泄漏。
	
所以需要使用weak关键字。

比如：

	class A{
		var b:B
	}

	class B{
		var a:A
	}

	var aa=A()
	var bb=B()
	
这之后即使设置aa和bb为nil，这样的两片内存也不会被释放。就可以简单的这么写：

	class A{
		weak var b:B
	}

	class B{
		var a:A
	}
	
weak不管写在那个类里面都是可以正确的释放。只是释放的顺序不同。

## unowned关键字
	
weak有局限的是只能针对var以及必须是可选型。如果不满足使用weak的条件的时候可以使用unowned关键字。
	
unowned不能是可选型。
	
unowned有危险性，因为它不能是可选型，所以它的指向可能是一片不应该被它使用的内存空间，这样就会报错。

## 闭包的强引用循环
	
闭包中可能存在类的引用，类中可能存在闭包的引用。这样形成了强引用循环，产生内存泄漏。
	
可以通过修改闭包的逻辑来打破循环。

如果闭包逻辑确实不能修改，就需要通过闭包捕获列表

## 闭包捕获列表
	
闭包中需要捕获的内容都可以写在捕获列表中。如果闭包和其捕获的对象相互引用，应该使用unowned，这样能够保证他们会同时被销毁。当然也可以使用weak，使用weak表示是可选类型，使用时就需要解包。

	num={ [unowned self] number in
		//…
	}
